From be3bd106a61405c2f577d496f8f8024037f8d9a9 Mon Sep 17 00:00:00 2001
From: David Friberg <dfriberg23@gmail.com>
Date: Sun, 20 Nov 2016 15:13:46 -0600
Subject: [PATCH 1/1] link against elogind library instead of systemd

---
 common/Makefile.am              |  2 ++
 common/gdm-common.c             |  2 +-
 common/gdm-log.c                |  2 +-
 configure.ac                    | 26 ++++++++++++++------------
 daemon/gdm-manager.c            |  2 +-
 daemon/gdm-server.c             |  4 ++--
 daemon/gdm-session-worker-job.c |  4 ++--
 daemon/gdm-session-worker.c     |  4 ++--
 libgdm/Makefile.am              |  4 +++-
 libgdm/gdm-user-switching.c     |  2 +-
 10 files changed, 29 insertions(+), 23 deletions(-)

diff --git a/common/Makefile.am b/common/Makefile.am
index 2e97090..2b8d8b7 100644
--- a/common/Makefile.am
+++ b/common/Makefile.am
@@ -68,10 +68,12 @@ libgdmcommon_la_CPPFLAGS = 		\
 libgdmcommon_la_CFLAGS =		\
 	$(COMMON_CFLAGS)		\
 	$(SYSTEMD_CFLAGS)	        \
+	$(ELOGIND_CFLAGS)	        \
 	$(NULL)
 
 libgdmcommon_la_LIBADD =		\
 	$(SYSTEMD_LIBS)	        \
+	$(ELOGIND_LIBS)	        \
 	$(NULL)
 
 libgdmcommon_la_LDFLAGS = 	\
diff --git a/common/gdm-common.c b/common/gdm-common.c
index 2ad134a..b5a5e36 100644
--- a/common/gdm-common.c
+++ b/common/gdm-common.c
@@ -40,7 +40,7 @@
 #endif
 
 #ifdef WITH_SYSTEMD
-#include <systemd/sd-login.h>
+#include <elogind/sd-login.h>
 #endif
 
 #define GDM_DBUS_NAME                            "org.gnome.DisplayManager"
diff --git a/common/gdm-log.c b/common/gdm-log.c
index 22d8c7d..8c4e286 100644
--- a/common/gdm-log.c
+++ b/common/gdm-log.c
@@ -31,7 +31,7 @@
 
 #include <syslog.h>
 #ifdef WITH_SYSTEMD
-#include <systemd/sd-daemon.h>
+#include <elogind/sd-daemon.h>
 #endif
 
 #include <glib.h>
diff --git a/configure.ac b/configure.ac
index fa3badd..3bcbab0 100644
--- a/configure.ac
+++ b/configure.ac
@@ -892,29 +892,31 @@ dnl ---------------------------------------------------------------------------
 dnl - Check for systemd support
 dnl ---------------------------------------------------------------------------
 
-PKG_CHECK_MODULES(SYSTEMD,
-                  [libsystemd],
-                  [have_systemd=yes], [have_systemd=no])
+PKG_CHECK_MODULES(ELOGIND,
+                  [libelogind],
+                  [have_elogind=yes], [have_elogind=no])
 
-if test "x$with_systemd" = "xauto" ; then
-        if test x$have_systemd = xno ; then
-                use_systemd=no
+if test "x$with_elogind" = "xauto" ; then
+        if test x$have_elogind = xno ; then
+                use_elogind=no
         else
-                use_systemd=yes
+                use_elogind=yes
         fi
 else
-        use_systemd="$with_systemd"
+        use_elogind="$with_elogind"
 fi
 
-if test "x$use_systemd" != "xno" ; then
-        if test "x$have_systemd" = "xno"; then
-                AC_MSG_ERROR([Systemd support explicitly required, but systemd not found])
+if test "x$use_elogind" != "xno" ; then
+        if test "x$have_elogind" = "xno"; then
+                AC_MSG_ERROR([Elogind support explicitly required, but elogind not found])
         fi
 
         AC_DEFINE(WITH_SYSTEMD, 1, [Define to enable systemd support])
 fi
 AC_SUBST(SYSTEMD_CFLAGS)
 AC_SUBST(SYSTEMD_LIBS)
+AC_SUBST(ELOGIND_CFLAGS)
+AC_SUBST(ELOGIND_LIBS)
 
 PKG_CHECK_MODULES(JOURNALD,
                   [libsystemd],
@@ -952,7 +954,7 @@ else
 fi
 
 if test "x$use_wayland" != "xno" ; then
-        if test "x$have_systemd" = "xno"; then
+        if test "x$have_elogind" = "xno"; then
                 AC_MSG_ERROR([wayland support explicitly required, but logind not found])
         fi
 
diff --git a/daemon/gdm-manager.c b/daemon/gdm-manager.c
index 39f075e..91fca80 100644
--- a/daemon/gdm-manager.c
+++ b/daemon/gdm-manager.c
@@ -35,7 +35,7 @@
 #include <glib-object.h>
 
 #ifdef WITH_SYSTEMD
-#include <systemd/sd-login.h>
+#include <elogind/sd-login.h>
 #endif
 
 #include "gdm-common.h"
diff --git a/daemon/gdm-server.c b/daemon/gdm-server.c
index 049a48d..fc57e43 100644
--- a/daemon/gdm-server.c
+++ b/daemon/gdm-server.c
@@ -44,11 +44,11 @@
 #endif
 
 #ifdef WITH_SYSTEMD
-#include <systemd/sd-daemon.h>
+#include <elogind/sd-daemon.h>
 #endif
 
 #ifdef ENABLE_SYSTEMD_JOURNAL
-#include <systemd/sd-journal.h>
+#include <elogind/sd-journal.h>
 #endif
 
 #include <glib/gi18n.h>
diff --git a/daemon/gdm-session-worker-job.c b/daemon/gdm-session-worker-job.c
index c117f70..545f7fe 100644
--- a/daemon/gdm-session-worker-job.c
+++ b/daemon/gdm-session-worker-job.c
@@ -37,11 +37,11 @@
 #endif
 
 #ifdef WITH_SYSTEMD
-#include <systemd/sd-daemon.h>
+#include <elogind/sd-daemon.h>
 #endif
 
 #ifdef ENABLE_SYSTEMD_JOURNAL
-#include <systemd/sd-journal.h>
+#include <elogind/sd-journal.h>
 #endif
 
 #include <glib.h>
diff --git a/daemon/gdm-session-worker.c b/daemon/gdm-session-worker.c
index 413a36d..dc40da6 100644
--- a/daemon/gdm-session-worker.c
+++ b/daemon/gdm-session-worker.c
@@ -52,11 +52,11 @@
 #include <X11/Xauth.h>
 
 #ifdef WITH_SYSTEMD
-#include <systemd/sd-daemon.h>
+#include <elogind/sd-daemon.h>
 #endif
 
 #ifdef ENABLE_SYSTEMD_JOURNAL
-#include <systemd/sd-journal.h>
+#include <elogind/sd-journal.h>
 #endif
 
 #ifdef HAVE_SELINUX
diff --git a/libgdm/Makefile.am b/libgdm/Makefile.am
index 99ada9a..37a1dcd 100644
--- a/libgdm/Makefile.am
+++ b/libgdm/Makefile.am
@@ -55,7 +55,8 @@ libgdm_HEADERS =                                                       \
 
 libgdm_la_CFLAGS =                                                     \
         $(LIBGDM_CFLAGS)                                               \
-	$(SYSTEMD_CFLAGS)                                              \
+        $(SYSTEMD_CFLAGS)                                              \
+        $(ELOGIND_CFLAGS)                                              \
         $(END_OF_LIST)
 libgdm_la_LDFLAGS =                                                    \
         -export-symbols-regex '^[^_].*'                                       \
@@ -66,6 +67,7 @@ libgdm_la_LDFLAGS =                                                    \
 libgdm_la_LIBADD =                                                     \
         $(LIBGDM_LIBS)                                                 \
         $(SYSTEMD_LIBS)                                                \
+        $(ELOGIND_LIBS)                                                \
         $(END_OF_LIST)
 
 libgdm_la_SOURCES =                                                    \
diff --git a/libgdm/gdm-user-switching.c b/libgdm/gdm-user-switching.c
index a195d05..810fa8b 100644
--- a/libgdm/gdm-user-switching.c
+++ b/libgdm/gdm-user-switching.c
@@ -32,7 +32,7 @@
 #include <gio/gio.h>
 
 #ifdef WITH_SYSTEMD
-#include <systemd/sd-login.h>
+#include <elogind/sd-login.h>
 #endif
 
 #include "common/gdm-common.h"
-- 
2.10.2

